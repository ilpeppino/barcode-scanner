<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/static/barcode_favicon.ico" />
    <title>Barcode Scanner ‚Üí Google Tasks</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #2d3748;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Header */
      .header {
        background: white;
        border-radius: 20px;
        padding: 24px 32px;
        margin-bottom: 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
      }

      .header-left h1 {
        font-size: 28px;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .header-left h1::before {
        content: "üì¶";
        font-size: 32px;
      }

      .active-list {
        color: #667eea;
        font-size: 16px;
        font-weight: 500;
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .tasklist-selector {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .tasklist-selector label {
        font-size: 14px;
        color: #718096;
        font-weight: 500;
      }

      select {
        padding: 10px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
        color: #2d3748;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        outline: none;
      }

      select:hover {
        border-color: #667eea;
      }

      select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      /* Main Grid */
      .main-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 24px;
        margin-bottom: 24px;
      }

      .card {
        background: white;
        border-radius: 20px;
        padding: 28px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
      }

      .card h3 {
        font-size: 20px;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .card h3::before {
        content: "";
        width: 4px;
        height: 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 2px;
      }

      /* Scanner Form */
      .scanner-form {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      input[type="text"] {
        padding: 14px 18px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 15px;
        transition: all 0.2s;
        outline: none;
        font-family: inherit;
      }

      input[type="text"]:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      button {
        padding: 14px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .clear-button {
        padding: 10px 18px;
        border-radius: 10px;
        border: 2px solid rgba(102, 126, 234, 0.3);
        background: rgba(255, 255, 255, 0.8);
        color: #4c51bf;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: none;
      }

      .clear-button:hover {
        border-color: #667eea;
        background: white;
        transform: translateY(-1px);
      }

      .clear-button:active {
        transform: translateY(0);
      }

      .camera-card button {
        margin-top: 12px;
      }

      .camera-card button.active {
        background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
      }

      .camera-video {
        margin-top: 16px;
        width: 100%;
        max-height: 320px;
        border-radius: 16px;
        background: #1a202c;
        display: block;
        object-fit: cover;
      }

      .camera-video.hidden {
        display: none;
      }

      .camera-status {
        margin-top: 12px;
        font-size: 14px;
        color: #4a5568;
        min-height: 1.2em;
      }

      .camera-status.ok {
        color: #22543d;
      }

      .camera-status.err {
        color: #742a2a;
      }

      .camera-status.info {
        color: #4a5568;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      button:active {
        transform: translateY(0);
      }

      .form-hint {
        font-size: 13px;
        color: #718096;
        margin-top: 8px;
        line-height: 1.5;
      }

      #msg {
        margin-top: 16px;
        padding: 12px 16px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
        display: none;
      }

      #msg.ok {
        background: #c6f6d5;
        color: #22543d;
        display: block;
        animation: slideIn 0.3s ease-out;
      }

      #msg.err {
        background: #fed7d7;
        color: #742a2a;
        display: block;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Recent Scans Table */
      .recent-scans {
        grid-column: 1 / -1;
      }

      .table-wrapper {
        overflow-x: auto;
        margin-top: 16px;
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }

      thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      th {
        padding: 16px;
        text-align: left;
        color: white;
        font-weight: 600;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      th:first-child {
        border-radius: 12px 0 0 0;
      }

      th:last-child {
        border-radius: 0 12px 0 0;
      }

      tbody tr {
        transition: background 0.2s;
      }

      tbody tr:hover {
        background: #f7fafc;
      }

      td {
        padding: 16px;
        border-bottom: 1px solid #e2e8f0;
        font-size: 14px;
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      tbody tr:last-child td:first-child {
        border-radius: 0 0 0 12px;
      }

      tbody tr:last-child td:last-child {
        border-radius: 0 0 12px 0;
      }

      .code-cell {
        font-family: "Monaco", "Courier New", monospace;
        font-weight: 600;
        color: #667eea;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #718096;
      }

      .empty-state::before {
        content: "üì≠";
        font-size: 48px;
        display: block;
        margin-bottom: 12px;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .header {
          padding: 20px;
        }

        .header-left h1 {
          font-size: 22px;
        }

        .main-grid {
          grid-template-columns: 1fr;
        }

        .card {
          padding: 20px;
        }
      }

      /* Loading Animation */
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .loading {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="header-left">
          <h1>Barcode Scanner</h1>
          <div class="active-list">
            Active List: <span id="active-list-title">My Tasks</span>
          </div>
        </div>
        <div class="header-controls">
          <div class="tasklist-selector">
            <label for="tasklist-select">Task List</label>
            <select id="tasklist-select">
              <option>Loading...</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Main Grid -->
      <div class="main-grid">
        <!-- Scanner Input Card -->
        <div class="card">
          <h3>Quick Scan</h3>
          <form id="f" class="scanner-form">
            <input
              id="code"
              type="text"
              placeholder="Scan barcode or enter manually..."
              autofocus
            />
            <input
              id="token"
              type="text"
              placeholder="Ingest Token"
              value="changeme"
            />
            <button type="submit">Add to Tasks</button>
            <div class="form-hint">
              üí° Use your USB scanner here ‚Äî it types like a keyboard and
              submits automatically
            </div>
          </form>
          <div id="msg"></div>
        </div>

        <div class="card camera-card">
          <h3>üì∑ Camera Scanner</h3>
          <p style="margin-bottom: 12px; line-height: 1.6">
            Use your device camera to scan barcodes when a USB scanner isn't
            handy.
          </p>
          <button type="button" id="camera-toggle">Start camera</button>
          <video
            id="camera-stream"
            class="camera-video hidden"
            playsinline
            muted
          ></video>
          <div id="camera-status" class="camera-status info">
            Camera idle. Tap ‚ÄúStart camera‚Äù to begin.
          </div>
        </div>

        <!-- Recent Scans Card -->
        <div class="card recent-scans">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
            <h3 style="margin-bottom:0;">Recent Scans</h3>
            <button id="clear-recent-btn" class="clear-button" type="button">
              Clear list
            </button>
          </div>
          <p style="color:#718096; font-size:14px; margin-top:12px;">
            Latest activity from this session
          </p>
          <div class="table-wrapper">
            <table id="t">
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>Product</th>
                  <th>Barcode</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="3" class="empty-state">
                    <div>No scans yet. Start scanning to see items here!</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      window.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("f");
        const codeInput = document.getElementById("code");
        const tokenInput = document.getElementById("token");
        const messageEl = document.getElementById("msg");
        const tbody = document.querySelector("#t tbody");
        const tasklistSelect = document.getElementById("tasklist-select");
        const clearButton = document.getElementById("clear-recent-btn");
        const activeListTitle = document.getElementById("active-list-title");
        const cameraToggle = document.getElementById("camera-toggle");
        const cameraStatus = document.getElementById("camera-status");
        const cameraVideo = document.getElementById("camera-stream");
        let cameraRunning = false;
        let cameraStream = null;
        let cameraDetector = null;
        let cameraFrameId = null;
        const cameraSeen = new Set();
        const BARCODE_FORMATS = [
          "ean_13",
          "ean_8",
          "code_128",
          "code_39",
          "itf",
          "qr_code",
        ];

        function displayStatus(el, state, text) {
          if (!el) return;
          if (el === messageEl) {
            const cls = state === "ok" ? "ok" : "err";
            el.textContent = text;
            el.className = cls;
            el.style.display = "block";
            if (cls === "ok") {
              setTimeout(() => {
                if (el.className === "ok") {
                  el.style.display = "none";
                }
              }, 3000);
            }
            return;
          }
          el.textContent = text;
          el.classList.remove("ok", "err", "info");
          if (state) {
            el.classList.add(state);
          }
        }

        async function refreshRecent() {
          if (!tbody) return;
          try {
            const res = await fetch("/recent");
            const data = await res.json();
            if (data.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="3" class="empty-state"><div>No scans yet. Start scanning to see items here!</div></td></tr>';
            } else {
              tbody.innerHTML = data
                .map(
                  (x) =>
                    `<tr><td>${x.when}</td><td>${x.title || "‚Äî"}</td><td class="code-cell">${x.code}</td></tr>`
                )
                .join("");
            }
          } catch (err) {
            console.error("Failed to refresh recent scans", err);
          }
        }

        async function loadTasklists() {
          if (!tasklistSelect) return;
          try {
            const res = await fetch("/tasklists");
            const data = await res.json();
            if (!Array.isArray(data.items)) return;
            tasklistSelect.innerHTML = "";
            for (const item of data.items) {
              const opt = document.createElement("option");
              opt.value = item.id;
              opt.textContent = item.title;
              if (item.id === data.selected) opt.selected = true;
              tasklistSelect.appendChild(opt);
            }
            if (activeListTitle) {
              const sel = tasklistSelect.options[tasklistSelect.selectedIndex];
              if (sel) activeListTitle.textContent = sel.textContent;
            }
          } catch (err) {
            console.error("Failed to load tasklists", err);
          }
        }

        async function switchTasklist() {
          if (!tasklistSelect) return;
          const tasklist_id = tasklistSelect.value;
          try {
            const res = await fetch("/tasklists/select", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ tasklist_id }),
            });
            const data = await res.json();
            if (!res.ok || !data.ok) {
              throw new Error(data.message || "Failed to switch list");
            }
            if (activeListTitle) {
              const sel = tasklistSelect.options[tasklistSelect.selectedIndex];
              activeListTitle.textContent =
                data.title || (sel ? sel.textContent : "");
            }
            if (messageEl) {
              displayStatus(
                messageEl,
                "ok",
                `‚úì Switched to list: ${
                  activeListTitle ? activeListTitle.textContent : ""
                }`
              );
            }
          } catch (err) {
            console.error("Unable to switch task list", err);
            if (messageEl) {
              displayStatus(
                messageEl,
                "err",
                "‚úó " + (err.message || "Unable to switch list")
              );
            }
            loadTasklists();
          }
        }

        async function postScan(code, statusEl, options = {}) {
          const target = statusEl || messageEl;
          if (!target) return false;
          const token = tokenInput ? tokenInput.value.trim() : "";
          if (!token) {
            displayStatus(
              target,
              "err",
              "‚úó Enter the ingest token before scanning."
            );
            return false;
          }
          try {
            const res = await fetch("/scan", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-Ingest-Token": token,
              },
              body: JSON.stringify({ code, token }),
            });
            const data = await res.json();
            const ok = res.ok;
            const prefix = ok ? "‚úì " : "‚úó ";
            displayStatus(
              target,
              ok ? "ok" : "err",
              prefix + (data.message || JSON.stringify(data))
            );
            if (ok) {
              refreshRecent();
              if (typeof options.onSuccess === "function") {
                options.onSuccess();
              }
            }
            return ok;
          } catch (err) {
            console.error("Failed to submit scan", err);
            displayStatus(
              target,
              "err",
              "‚úó " + (err.message || "Unable to submit scan")
            );
            return false;
          }
        }

        async function submitScan(e) {
          if (e) {
            e.preventDefault();
            e.stopPropagation();
          }
          if (!codeInput || !messageEl) return;
          const code = codeInput.value.trim();
          if (!code) {
            displayStatus(
              messageEl,
              "err",
              "‚ö†Ô∏è Please scan or type a code first"
            );
            return;
          }
          const ok = await postScan(code, messageEl);
          if (ok) {
            codeInput.value = "";
            codeInput.focus();
          }
        }

        function hasSecureCameraOrigin() {
          if (window.isSecureContext) return true;
          return ["localhost", "127.0.0.1"].includes(window.location.hostname);
        }

        async function startCamera() {
          if (cameraRunning || !cameraToggle) return;
          if (!cameraStatus || !cameraVideo) return;
          if (
            !navigator.mediaDevices ||
            typeof navigator.mediaDevices.getUserMedia !== "function"
          ) {
            displayStatus(
              cameraStatus,
              "err",
              "Camera API unavailable in this browser."
            );
            return;
          }
          if (!hasSecureCameraOrigin()) {
            displayStatus(
              cameraStatus,
              "err",
              "Camera access requires HTTPS or localhost."
            );
            return;
          }
          if (!("BarcodeDetector" in window)) {
            displayStatus(
              cameraStatus,
              "err",
              "BarcodeDetector API not supported. Use a modern Chrome or Safari."
            );
            return;
          }
          if (!tokenInput || !tokenInput.value.trim()) {
            displayStatus(
              cameraStatus,
              "err",
              "Enter the ingest token before starting the camera."
            );
            return;
          }
          cameraToggle.disabled = true;
          try {
            if (!cameraDetector) {
              cameraDetector = new BarcodeDetector({ formats: BARCODE_FORMATS });
            }
            cameraStream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: "environment" },
            });
            cameraVideo.srcObject = cameraStream;
            cameraVideo.classList.remove("hidden");
            cameraSeen.clear();
            try {
              await cameraVideo.play();
            } catch (err) {
              console.warn("Camera playback warning", err);
            }
            cameraRunning = true;
            cameraToggle.textContent = "Stop camera";
            cameraToggle.classList.add("active");
            displayStatus(
              cameraStatus,
              "info",
              "Camera active. Scan a barcode to send it."
            );
            cameraFrameId = requestAnimationFrame(scanFrame);
          } catch (err) {
            console.error("Failed to start camera", err);
            displayStatus(
              cameraStatus,
              "err",
              err.message || "Unable to access camera."
            );
            if (cameraStream) {
              cameraStream.getTracks().forEach((track) => track.stop());
              cameraStream = null;
            }
            cameraRunning = false;
            cameraSeen.clear();
            if (cameraVideo) {
              cameraVideo.pause();
              cameraVideo.srcObject = null;
              cameraVideo.classList.add("hidden");
            }
            if (cameraToggle) {
              cameraToggle.textContent = "Start camera";
              cameraToggle.classList.remove("active");
            }
          } finally {
            cameraToggle.disabled = false;
          }
        }

        function stopCamera() {
          if (cameraFrameId) {
            cancelAnimationFrame(cameraFrameId);
            cameraFrameId = null;
          }
          if (cameraStream) {
            cameraStream.getTracks().forEach((track) => track.stop());
            cameraStream = null;
          }
          cameraSeen.clear();
          if (cameraVideo) {
            cameraVideo.pause();
            cameraVideo.srcObject = null;
            cameraVideo.classList.add("hidden");
          }
          if (cameraToggle) {
            cameraToggle.textContent = "Start camera";
            cameraToggle.classList.remove("active");
          }
          if (cameraStatus) {
            displayStatus(cameraStatus, "info", "Camera stopped.");
          }
          cameraRunning = false;
        }

        async function scanFrame() {
          if (!cameraRunning || !cameraDetector) return;
          try {
            const barcodes = await cameraDetector.detect(cameraVideo);
            for (const barcode of barcodes) {
              const code = (barcode.rawValue || "").trim();
              if (!code || cameraSeen.has(code)) continue;
              cameraSeen.add(code);
              const ok = await postScan(code, cameraStatus, {
                onSuccess: () => {
                  if (cameraRunning) {
                    setTimeout(() => {
                      if (cameraRunning) {
                        displayStatus(
                          cameraStatus,
                          "info",
                          "Camera active. Ready for the next barcode."
                        );
                      }
                    }, 2500);
                  }
                },
              });
              if (!ok) {
                cameraSeen.delete(code);
              } else {
                setTimeout(() => cameraSeen.delete(code), 5000);
              }
            }
          } catch (err) {
            console.error("Barcode detection failed", err);
          }
          if (cameraRunning) {
            cameraFrameId = requestAnimationFrame(scanFrame);
          }
        }

        // Initial data fetches
        refreshRecent();
        setInterval(refreshRecent, 1500);

        if (tasklistSelect) {
          loadTasklists();
          tasklistSelect.addEventListener("change", switchTasklist);
        }

        if (codeInput) {
          codeInput.focus();
        }

        if (clearButton) {
          clearButton.addEventListener("click", async () => {
            try {
              const res = await fetch("/recent/clear", { method: "POST" });
              if (!res.ok) throw new Error("Request failed");
              const data = await res.json();
              if (!data.ok) throw new Error("Unable to clear list");
              refreshRecent();
              if (messageEl) {
                displayStatus(messageEl, "ok", "‚úì Recent list cleared");
              }
            } catch (err) {
              console.error("Failed to clear recent list", err);
              if (messageEl) {
                displayStatus(
                  messageEl,
                  "err",
                  "‚úó " + (err.message || "Failed to clear list")
                );
              }
            }
          });
        }

        if (form) {
          form.addEventListener("submit", submitScan);
        }

        if (cameraToggle) {
          cameraToggle.addEventListener("click", async () => {
            if (cameraRunning) {
              stopCamera();
            } else {
              await startCamera();
            }
          });
        }

        window.addEventListener("beforeunload", () => {
          if (cameraRunning) {
            stopCamera();
          }
        });

        document.addEventListener("visibilitychange", () => {
          if (document.hidden) {
            stopCamera();
          }
        });
      });
    </script>
  </body>
</html>
